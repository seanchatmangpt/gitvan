# Basic Job Setup

## üéØ **Recipe Overview**

**Category**: Foundation  
**Difficulty**: Beginner  
**Time**: 15 minutes  
**Prerequisites**: GitVan installed, basic Node.js knowledge

## üìã **Problem**

You want to create your first GitVan job but don't know where to start. You need a simple, working example that demonstrates the basic concepts.

## üç≥ **Solution**

### **Step 1: Create Job Directory Structure**

```bash
# Create the jobs directory
mkdir -p jobs/hello-world

# Create your first job file
touch jobs/hello-world/greeting.mjs
```

### **Step 2: Write Your First Job**

```javascript
// jobs/hello-world/greeting.mjs
import { defineJob } from "gitvan/define";
import { useGit } from "gitvan/useGit";

export default defineJob({
  meta: {
    desc: "A simple greeting job that demonstrates basic GitVan concepts",
    tags: ["hello", "example", "beginner"]
  },
  async run({ ctx }) {
    const git = useGit();
    
    // Get repository information
    const head = await git.head();
    const branch = await git.getCurrentBranch();
    const isClean = await git.isClean();
    
    // Create a simple greeting message
    const greeting = {
      message: "Hello from GitVan!",
      timestamp: ctx.nowISO,
      repository: {
        head: head.substring(0, 8),
        branch,
        isClean
      },
      environment: {
        nodeVersion: process.version,
        platform: process.platform
      }
    };
    
    // Log the greeting
    ctx.logger.log("üéâ Greeting generated successfully!");
    ctx.logger.log(`Repository: ${branch} (${head.substring(0, 8)})`);
    ctx.logger.log(`Clean: ${isClean ? "Yes" : "No"}`);
    
    return {
      ok: true,
      artifacts: [],
      data: greeting
    };
  }
});
```

### **Step 3: Create Configuration File**

```javascript
// gitvan.config.js
export default {
  root: process.cwd(),
  jobs: { dir: "jobs" },
  templates: { 
    engine: "nunjucks", 
    dirs: ["templates"] 
  },
  receipts: { ref: "refs/notes/gitvan/results" },
  hooks: {
    "job:before"({ id }) {
      console.log(`üöÄ Starting job: ${id}`);
    },
    "job:after"({ id, result }) {
      console.log(`‚úÖ Job completed: ${id} (${result.ok ? "SUCCESS" : "FAILED"})`);
    }
  }
};
```

### **Step 4: Test Your Job**

```bash
# List all jobs
node -e "import('./dev.mjs').then(m=>m.list())"

# Run your greeting job
node -e "import('./dev.mjs').then(m=>m.run('hello-world:greeting'))"
```

## üîç **Explanation**

### **Job Structure**

1. **Import Dependencies**: Import required GitVan modules
2. **Define Job**: Use `defineJob()` to create a job definition
3. **Metadata**: Provide job description and tags
4. **Run Function**: Implement the job logic
5. **Return Result**: Return success status, artifacts, and data

### **Key Concepts**

- **`ctx`**: Execution context with repository info, timestamps, and logger
- **`useGit()`**: Git operations composable for repository interactions
- **`meta`**: Job metadata for discovery and organization
- **`artifacts`**: Files or outputs created by the job
- **`data`**: Structured data returned by the job

### **Git Operations**

- **`git.head()`**: Get current commit SHA
- **`git.getCurrentBranch()`**: Get current branch name
- **`git.isClean()`**: Check if working directory is clean

## üîÑ **Variations**

### **Variation 1: File Output Job**

```javascript
// jobs/hello-world/file-output.mjs
import { defineJob } from "gitvan/define";
import { useGit } from "gitvan/useGit";
import { promises as fs } from "node:fs";
import { join } from "pathe";

export default defineJob({
  meta: {
    desc: "Generate a greeting file with repository information",
    tags: ["hello", "file-output", "example"]
  },
  async run({ ctx }) {
    const git = useGit();
    
    // Get repository information
    const head = await git.head();
    const branch = await git.getCurrentBranch();
    const commitCount = await git.getCommitCount();
    
    // Create greeting content
    const content = `# Hello from GitVan!

Generated at: ${ctx.nowISO}

## Repository Information
- **Branch**: ${branch}
- **Head**: ${head.substring(0, 8)}
- **Commits**: ${commitCount}
- **Clean**: ${await git.isClean() ? "Yes" : "No"}

## Environment
- **Node.js**: ${process.version}
- **Platform**: ${process.platform}

---
*Generated by GitVan Jobs System*
`;

    // Write to file
    const outputPath = join(ctx.root, "dist", "greeting.md");
    await fs.mkdir(join(ctx.root, "dist"), { recursive: true });
    await fs.writeFile(outputPath, content);
    
    ctx.logger.log(`üìù Greeting file created: ${outputPath}`);
    
    return {
      ok: true,
      artifacts: [outputPath],
      data: {
        outputPath,
        contentLength: content.length,
        timestamp: ctx.nowISO
      }
    };
  }
});
```

### **Variation 2: Template-Based Job**

```javascript
// jobs/hello-world/template-greeting.mjs
import { defineJob } from "gitvan/define";
import { useGit } from "gitvan/useGit";
import { useTemplate } from "gitvan/useTemplate";

export default defineJob({
  meta: {
    desc: "Generate greeting using Nunjucks template",
    tags: ["hello", "template", "nunjucks"]
  },
  async run({ ctx }) {
    const git = useGit();
    const template = await useTemplate();
    
    // Get repository information
    const head = await git.head();
    const branch = await git.getCurrentBranch();
    const commitCount = await git.getCommitCount();
    
    // Prepare template data
    const data = {
      greeting: "Hello from GitVan!",
      timestamp: ctx.nowISO,
      repository: {
        head: head.substring(0, 8),
        branch,
        commitCount,
        isClean: await git.isClean()
      },
      environment: {
        nodeVersion: process.version,
        platform: process.platform
      }
    };
    
    // Render template to file
    const outputPath = await template.renderToFile(
      "greeting.njk",
      "dist/greeting-template.md",
      data
    );
    
    ctx.logger.log(`üìù Template greeting created: ${outputPath}`);
    
    return {
      ok: true,
      artifacts: [outputPath],
      data
    };
  }
});
```

### **Template File**

```njk
# {{ greeting }}

Generated at: {{ timestamp }}

## Repository Information
- **Branch**: {{ repository.branch }}
- **Head**: {{ repository.head }}
- **Commits**: {{ repository.commitCount }}
- **Clean**: {{ repository.isClean | titleize }}

## Environment
- **Node.js**: {{ environment.nodeVersion }}
- **Platform**: {{ environment.platform | titleize }}

---
*Generated by GitVan Jobs System*
```

## üéØ **Best Practices**

### **Job Design**
- **Keep jobs focused**: One job, one responsibility
- **Use descriptive metadata**: Clear descriptions and relevant tags
- **Handle errors gracefully**: Use try-catch blocks for error handling
- **Return meaningful results**: Include artifacts and structured data

### **Git Operations**
- **Check repository state**: Always verify repository status
- **Handle edge cases**: Account for empty repositories or missing branches
- **Use appropriate git commands**: Choose the right git operations for your needs

### **File Operations**
- **Create directories**: Ensure output directories exist
- **Use absolute paths**: Use `ctx.root` for consistent path handling
- **Clean up resources**: Remove temporary files when done

### **Error Handling**
```javascript
async run({ ctx }) {
  try {
    // Job logic here
    return { ok: true, artifacts: [], data: result };
  } catch (error) {
    ctx.logger.error(`Job failed: ${error.message}`);
    throw error; // Re-throw to mark job as failed
  }
}
```

## üîó **Related Recipes**

- [Configuration Management](./configuration-management.md) - Managing job configurations
- [Template System](./template-system.md) - Advanced template usage
- [Error Handling](./error-handling.md) - Robust error handling patterns

## üìö **Resources**

- [GitVan Documentation](../../README.md)
- [Job Definition API](../../docs/api-reference.md)
- [Git Operations Guide](../../docs/git-operations.md)

## ü§ù **Contributors**

- **Author**: GitVan Team
- **Last Updated**: 2024-09-16
- **Version**: 1.0.0

---

**Next Recipe**: [Configuration Management](./configuration-management.md)
