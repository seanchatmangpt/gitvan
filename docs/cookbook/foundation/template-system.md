# Template System

## üéØ **Recipe Overview**

**Category**: Foundation  
**Difficulty**: Intermediate  
**Time**: 45 minutes  
**Prerequisites**: Basic GitVan knowledge, Nunjucks template experience

## üìã **Problem**

You need to generate dynamic content using templates but want to leverage GitVan's template system with custom filters, reusable components, and advanced templating features.

## üç≥ **Solution**

### **Step 1: Create Template Directory Structure**

```bash
# Create template directories
mkdir -p templates/{layouts,components,partials}

# Create template files
touch templates/layouts/base.njk
touch templates/components/header.njk
touch templates/components/footer.njk
touch templates/partials/meta.njk
```

### **Step 2: Create Base Layout Template**

```njk
<!-- templates/layouts/base.njk -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title | default("GitVan Generated Document") }}</title>
    {% include "partials/meta.njk" %}
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 30px; }
        .footer { border-top: 1px solid #eee; padding-top: 20px; margin-top: 30px; color: #666; }
        .meta { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .code { background: #f1f3f4; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        {% include "components/header.njk" %}
        
        <main>
            {% block content %}{% endblock %}
        </main>
        
        {% include "components/footer.njk" %}
    </div>
</body>
</html>
```

### **Step 3: Create Component Templates**

```njk
<!-- templates/components/header.njk -->
<header class="header">
    <h1>{{ title | default("GitVan Document") }}</h1>
    {% if subtitle %}
        <p class="subtitle">{{ subtitle }}</p>
    {% endif %}
    {% if generatedAt %}
        <div class="meta">
            <strong>Generated:</strong> {{ generatedAt | date("YYYY-MM-DD HH:mm:ss") }}
            {% if repository %}
                | <strong>Repository:</strong> <span class="code">{{ repository.branch }}</span>
                | <strong>Commit:</strong> <span class="code">{{ repository.head }}</span>
            {% endif %}
        </div>
    {% endif %}
</header>
```

```njk
<!-- templates/components/footer.njk -->
<footer class="footer">
    <p>
        Generated by <strong>GitVan Jobs System</strong>
        {% if version %}v{{ version }}{% endif %}
        {% if environment %}in {{ environment | titleize }} environment{% endif %}
    </p>
    {% if links %}
        <nav>
            {% for link in links %}
                <a href="{{ link.url }}">{{ link.text }}</a>
                {% if not loop.last %} | {% endif %}
            {% endfor %}
        </nav>
    {% endif %}
</footer>
```

### **Step 4: Create Partial Templates**

```njk
<!-- templates/partials/meta.njk -->
<meta name="description" content="{{ description | default('GitVan generated document') }}">
<meta name="generator" content="GitVan Jobs System">
{% if keywords %}
    <meta name="keywords" content="{{ keywords | join(', ') }}">
{% endif %}
{% if author %}
    <meta name="author" content="{{ author }}">
{% endif %}
```

### **Step 5: Create Advanced Template Job**

```javascript
// jobs/templates/advanced-template.mjs
import { defineJob } from "gitvan/define";
import { useGit } from "gitvan/useGit";
import { useTemplate } from "gitvan/useTemplate";

export default defineJob({
  meta: {
    desc: "Generate advanced document using template system with layouts and components",
    tags: ["template", "advanced", "layout", "components"]
  },
  async run({ ctx }) {
    const git = useGit();
    const template = await useTemplate();
    
    // Get repository information
    const head = await git.currentHead();
    const branch = await git.currentBranch();
    const commitCount = await git.getCommitCount();
    const isClean = await git.isClean();
    
    // Get recent commits for changelog
    const logOutput = await git.log("%h%x09%s%x09%an%x09%ad", ["-n", "10"]);
    const commits = logOutput.split("\n").filter(Boolean).map(line => {
      const [hash, subject, author, date] = line.split("\t");
      return { hash, subject, author, date };
    });
    
    // Prepare template data
    const data = {
      title: "GitVan Advanced Template Demo",
      subtitle: "Demonstrating advanced templating features",
      description: "A comprehensive example of GitVan's template system",
      keywords: ["gitvan", "templates", "automation", "git", "workflow"],
      author: "GitVan Team",
      generatedAt: ctx.nowISO,
      version: "2.0.0",
      environment: process.env.NODE_ENV || "development",
      repository: {
        head: head.substring(0, 8),
        branch,
        commitCount,
        isClean
      },
      commits,
      sections: [
        {
          title: "Repository Information",
          content: "Current repository status and information",
          items: [
            { label: "Branch", value: branch },
            { label: "Head Commit", value: head.substring(0, 8) },
            { label: "Total Commits", value: commitCount.toString() },
            { label: "Working Directory", value: isClean ? "Clean" : "Modified" }
          ]
        },
        {
          title: "Recent Commits",
          content: "Latest commits in the repository",
          items: commits.map(commit => ({
            label: commit.hash,
            value: commit.subject,
            meta: `${commit.author} - ${commit.date}`
          }))
        },
        {
          title: "System Information",
          content: "Current system and environment details",
          items: [
            { label: "Node.js Version", value: process.version },
            { label: "Platform", value: process.platform },
            { label: "Environment", value: process.env.NODE_ENV || "development" },
            { label: "Generated At", value: ctx.nowISO }
          ]
        }
      ],
      links: [
        { text: "GitVan Documentation", url: "https://github.com/sac/gitvan" },
        { text: "Template Guide", url: "https://github.com/sac/gitvan/docs/templates" },
        { text: "Job Examples", url: "https://github.com/sac/gitvan/docs/cookbook" }
      ]
    };
    
    // Render template to file
    const outputPath = await template.renderToFile(
      "advanced-document.njk",
      "dist/advanced-template-demo.html",
      data
    );
    
    ctx.logger.log(`üìù Advanced template document created: ${outputPath}`);
    
    return {
      ok: true,
      artifacts: [outputPath],
      data: {
        outputPath,
        sections: data.sections.length,
        commits: data.commits.length,
        templateData: data
      }
    };
  }
});
```

### **Step 6: Create Advanced Document Template**

```njk
<!-- templates/advanced-document.njk -->
{% extends "layouts/base.njk" %}

{% block content %}
<div class="document">
    {% for section in sections %}
        <section class="section">
            <h2>{{ section.title }}</h2>
            <p class="section-description">{{ section.content }}</p>
            
            <div class="items">
                {% for item in section.items %}
                    <div class="item">
                        <div class="item-header">
                            <strong>{{ item.label }}</strong>
                            {% if item.meta %}
                                <span class="item-meta">{{ item.meta }}</span>
                            {% endif %}
                        </div>
                        <div class="item-content">{{ item.value }}</div>
                    </div>
                {% endfor %}
            </div>
        </section>
    {% endfor %}
    
    {% if commits %}
        <section class="section">
            <h2>Recent Commits</h2>
            <div class="commits">
                {% for commit in commits %}
                    <div class="commit">
                        <div class="commit-header">
                            <span class="commit-hash">{{ commit.hash }}</span>
                            <span class="commit-author">{{ commit.author }}</span>
                            <span class="commit-date">{{ commit.date | date("MMM DD, YYYY") }}</span>
                        </div>
                        <div class="commit-message">{{ commit.subject }}</div>
                    </div>
                {% endfor %}
            </div>
        </section>
    {% endif %}
</div>

<style>
.section { margin-bottom: 40px; }
.section h2 { color: #333; border-bottom: 2px solid #007acc; padding-bottom: 10px; }
.section-description { color: #666; margin-bottom: 20px; }
.items { display: grid; gap: 15px; }
.item { background: #f8f9fa; padding: 15px; border-radius: 5px; }
.item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.item-meta { color: #666; font-size: 0.9em; }
.item-content { color: #333; }
.commits { display: grid; gap: 10px; }
.commit { background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #007acc; }
.commit-header { display: flex; gap: 15px; margin-bottom: 8px; }
.commit-hash { font-family: monospace; background: #e9ecef; padding: 2px 6px; border-radius: 3px; }
.commit-author { color: #666; }
.commit-date { color: #666; font-size: 0.9em; }
.commit-message { color: #333; font-weight: 500; }
</style>
{% endblock %}
```

## üîç **Explanation**

### **Template Architecture**

1. **Layouts**: Base templates with common structure
2. **Components**: Reusable template components
3. **Partials**: Small template fragments
4. **Blocks**: Content areas for extension

### **Template Inheritance**

- **`extends`**: Inherit from a base template
- **`block`**: Define content areas
- **`include`**: Include other templates
- **`import`**: Import template macros

### **Custom Filters**

GitVan provides built-in filters:
- **`capitalize`**: Capitalize first letter
- **`pluralize`**: Convert to plural form
- **`camelize`**: Convert to camelCase
- **`underscore`**: Convert to snake_case
- **`dasherize`**: Convert to kebab-case
- **`humanize`**: Convert to human-readable form
- **`titleize`**: Convert to Title Case
- **`json`**: Pretty-print JSON

## üîÑ **Variations**

### **Variation 1: Multi-Format Output**

```javascript
// jobs/templates/multi-format.mjs
import { defineJob } from "gitvan/define";
import { useTemplate } from "gitvan/useTemplate";

export default defineJob({
  meta: {
    desc: "Generate documents in multiple formats using templates",
    tags: ["template", "multi-format", "html", "markdown"]
  },
  async run({ ctx }) {
    const template = await useTemplate();
    
    const data = {
      title: "Multi-Format Document",
      content: "This document is generated in multiple formats",
      timestamp: ctx.nowISO
    };
    
    // Generate HTML version
    const htmlPath = await template.renderToFile(
      "document.njk",
      "dist/document.html",
      { ...data, format: "html" }
    );
    
    // Generate Markdown version
    const markdownPath = await template.renderToFile(
      "document-markdown.njk",
      "dist/document.md",
      { ...data, format: "markdown" }
    );
    
    return {
      ok: true,
      artifacts: [htmlPath, markdownPath],
      data: { htmlPath, markdownPath }
    };
  }
});
```

### **Variation 2: Dynamic Template Selection**

```javascript
// jobs/templates/dynamic-template.mjs
import { defineJob } from "gitvan/define";
import { useTemplate } from "gitvan/useTemplate";

export default defineJob({
  meta: {
    desc: "Select template dynamically based on data",
    tags: ["template", "dynamic", "selection"]
  },
  async run({ ctx, payload }) {
    const template = await useTemplate();
    
    const documentType = payload?.type || "default";
    const templateName = `templates/${documentType}.njk`;
    
    const data = {
      title: `${documentType | titleize} Document`,
      content: `This is a ${documentType} document`,
      timestamp: ctx.nowISO,
      type: documentType
    };
    
    const outputPath = await template.renderToFile(
      templateName,
      `dist/${documentType}-document.html`,
      data
    );
    
    return {
      ok: true,
      artifacts: [outputPath],
      data: { outputPath, templateName, documentType }
    };
  }
});
```

### **Variation 3: Template Macros**

```njk
<!-- templates/macros/common.njk -->
{% macro renderSection(title, items) %}
<section class="section">
    <h2>{{ title }}</h2>
    <div class="items">
        {% for item in items %}
            <div class="item">
                <strong>{{ item.label }}:</strong> {{ item.value }}
            </div>
        {% endfor %}
    </div>
</section>
{% endmacro %}

{% macro renderCommit(commit) %}
<div class="commit">
    <span class="hash">{{ commit.hash }}</span>
    <span class="message">{{ commit.subject }}</span>
    <span class="author">{{ commit.author }}</span>
</div>
{% endmacro %}
```

```njk
<!-- templates/using-macros.njk -->
{% import "macros/common.njk" as common %}

{% extends "layouts/base.njk" %}

{% block content %}
    {{ common.renderSection("Repository Info", repositoryItems) }}
    {{ common.renderSection("System Info", systemItems) }}
    
    <section class="commits">
        <h2>Recent Commits</h2>
        {% for commit in commits %}
            {{ common.renderCommit(commit) }}
        {% endfor %}
    </section>
{% endblock %}
```

## üéØ **Best Practices**

### **Template Organization**
- **Logical structure**: Organize templates by purpose and reusability
- **Naming conventions**: Use clear, descriptive names
- **Separation of concerns**: Keep layouts, components, and content separate

### **Performance**
- **Template caching**: Enable caching in production
- **Minimal includes**: Avoid excessive template includes
- **Efficient loops**: Use appropriate loop constructs

### **Maintainability**
- **Documentation**: Document template variables and usage
- **Version control**: Keep templates in version control
- **Testing**: Test templates with various data sets

### **Security**
- **Input validation**: Validate template data
- **XSS prevention**: Use appropriate escaping
- **Access control**: Restrict template access

## üîó **Related Recipes**

- [Basic Job Setup](./basic-job-setup.md) - Getting started with jobs
- [Configuration Management](./configuration-management.md) - Managing configurations
- [Error Handling](./error-handling.md) - Robust error handling patterns

## üìö **Resources**

- [Nunjucks Documentation](https://mozilla.github.io/nunjucks/)
- [GitVan Template Guide](../../docs/templates.md)
- [Template Filters](../../docs/template-filters.md)

## ü§ù **Contributors**

- **Author**: GitVan Team
- **Last Updated**: 2024-09-16
- **Version**: 1.0.0

---

**Next Recipe**: [Error Handling](./error-handling.md)
