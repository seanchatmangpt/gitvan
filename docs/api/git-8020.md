# GitVan v2 — 80/20 Git Implementation

## Overview

GitVan v2 implements a **true 80/20 approach** to Git commands, focusing only on the essential operations that GitVan actually uses. This prevents bloat while ensuring all GitVan functionality works perfectly.

## The 80/20 Principle Applied

### What We Implement (The Essential 20%)
Only the Git operations that GitVan actually needs for its core functionality:

1. **Repository Information** - Basic repo context
2. **Worktree Management** - Critical for daemon operations  
3. **Status & Change Detection** - Essential for event detection
4. **Commit History** - Required for event processing
5. **Basic Write Operations** - Core Git operations
6. **Git Notes System** - Critical for receipts and metadata
7. **Atomic Ref Operations** - Essential for distributed locks
8. **Essential Plumbing** - Required for pack operations
9. **Basic Branch Operations** - Only for worktree management
10. **Basic Checkout** - Only for worktree switching

### What We Exclude (The Bloat 80%)
Complex Git operations that GitVan doesn't actually use:

❌ **Remote Operations** - `fetch`, `push`, `pull` (GitVan uses pack registry)
❌ **Complex History** - `merge`, `rebase`, `cherry-pick`, `revert` (GitVan uses worktrees)
❌ **Stash Operations** - `stash` (GitVan uses worktrees for isolation)
❌ **Reset Operations** - `reset` (GitVan uses atomic refs)
❌ **Diff Operations** - `diff` (GitVan uses status for change detection)
❌ **Complex Branch Management** - Advanced branch operations

## Implementation

### Core File
- **`src/composables/git-8020.mjs`** - The focused 80/20 implementation

### Usage
```javascript
import { useGit8020 } from 'gitvan/composables/git-8020';
import { withGitVan } from 'gitvan/core/context';

await withGitVan({ cwd: '/path/to/repo' }, async () => {
  const git = useGit8020();
  
  // Essential GitVan operations
  const branch = await git.branch();
  const worktrees = await git.listWorktrees();
  const isClean = await git.isClean();
  
  // Git notes for receipts
  await git.noteAdd('gitvan/receipt', 'Execution completed');
  
  // Atomic refs for locks
  const acquired = await git.updateRefCreate('refs/gitvan/lock', await git.head());
});
```

## Key Benefits

### 1. **No Bloat**
- Only implements what GitVan actually uses
- Eliminates unused Git commands that add complexity
- Smaller bundle size and faster loading

### 2. **Focused Functionality**
- Every command serves a specific GitVan need
- Clear purpose and usage patterns
- Easy to understand and maintain

### 3. **Performance**
- No lazy loading overhead
- All operations available immediately
- Optimized for GitVan's usage patterns

### 4. **Maintainability**
- Single focused file
- Clear separation of concerns
- Easy to extend if needed

## GitVan Use Cases Covered

### Pack Management
- **Git Notes**: Store pack metadata and receipts
- **Atomic Refs**: Implement distributed locks
- **Plumbing**: Hash objects and write trees

### Execution Tracking
- **Commits**: Record execution history
- **Status**: Detect changes and events
- **History**: Process commit events

### Worktree Operations
- **Worktrees**: Manage execution isolation
- **Branches**: Create execution branches
- **Checkout**: Switch between execution contexts

### Daemon Operations
- **Locks**: Prevent concurrent execution
- **Receipts**: Store execution results
- **Context**: Maintain execution state

## Comparison

| Aspect | Full Git | Modular Git | 80/20 Git |
|--------|----------|-------------|-----------|
| **Commands** | ~172 | ~30 | ~20 |
| **File Size** | Large | Medium | Small |
| **Loading** | Immediate | Lazy | Immediate |
| **Complexity** | High | Medium | Low |
| **GitVan Coverage** | 100% | 100% | 100% |
| **Maintenance** | Hard | Medium | Easy |

## Testing

The 80/20 implementation includes comprehensive tests:

```bash
# Test 80/20 implementation
node test-git-8020.mjs
```

**Test Results**: ✅ 12/12 tests passed
- Repository information ✅
- Worktree management ✅
- Status detection ✅
- Commit operations ✅
- Git notes system ✅
- Atomic ref operations ✅
- Basic branch operations ✅
- Essential plumbing ✅

## Migration

### From Full Git Implementation
```javascript
// Before
import { useGit } from 'gitvan/composables/git';
const git = useGit();
await git.diff(); // Not needed by GitVan

// After  
import { useGit8020 } from 'gitvan/composables/git-8020';
const git = useGit8020();
// Only essential operations available
```

### From Modular Implementation
```javascript
// Before
import { useGitModular } from 'gitvan/composables/git-modular';
const git = useGitModular();
await git.diff.diff(); // Complex API

// After
import { useGit8020 } from 'gitvan/composables/git-8020';
const git = useGit8020();
await git.statusPorcelain(); // Simple, direct API
```

## Conclusion

The 80/20 Git implementation provides **exactly what GitVan needs** without any bloat. It's:

- **Focused**: Only essential operations
- **Fast**: No unnecessary overhead
- **Simple**: Clear, direct API
- **Complete**: Covers all GitVan use cases
- **Maintainable**: Easy to understand and extend

This approach ensures GitVan remains lightweight while providing all the Git functionality it actually uses for pack management, execution tracking, and worktree operations.
