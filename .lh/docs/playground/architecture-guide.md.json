{
    "sourceFile": "docs/playground/architecture-guide.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1758051254570,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1758051254570,
            "name": "Commit-0",
            "content": "# GitVan Playground - Architecture Guide\n\n## ğŸ—ï¸ Architecture Overview\n\nThe GitVan playground demonstrates a complete Git-native job execution system with advanced features including job discovery, execution, template rendering, git integration, cron scheduling, event-driven jobs, and hooks.\n\n## ğŸ“ System Architecture\n\n### High-Level Architecture\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                    GitVan Playground                        â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚\nâ”‚  â”‚   Job CLI   â”‚  â”‚   Daemon    â”‚  â”‚   Config    â”‚        â”‚\nâ”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚        â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚\nâ”‚  â”‚ Job Runner  â”‚  â”‚  Template   â”‚  â”‚    Git      â”‚        â”‚\nâ”‚  â”‚             â”‚  â”‚   Engine    â”‚  â”‚  Composable â”‚        â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚\nâ”‚  â”‚   Cron     â”‚  â”‚   Events    â”‚  â”‚   Hooks     â”‚        â”‚\nâ”‚  â”‚ Scheduler  â”‚  â”‚ Evaluator   â”‚  â”‚   System    â”‚        â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚\nâ”‚  â”‚   Git      â”‚  â”‚   File      â”‚  â”‚   Config    â”‚        â”‚\nâ”‚  â”‚ Operations â”‚  â”‚   System    â”‚  â”‚   System    â”‚        â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Component Relationships\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚   dev.mjs   â”‚â”€â”€â”€â–¶â”‚  Job CLI    â”‚â”€â”€â”€â–¶â”‚ Job Runner  â”‚\nâ”‚             â”‚    â”‚             â”‚    â”‚             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n       â”‚                   â”‚                   â”‚\n       â–¼                   â–¼                   â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚   Config    â”‚    â”‚   Daemon    â”‚    â”‚   Git       â”‚\nâ”‚   Loader    â”‚    â”‚             â”‚    â”‚ Composable  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n       â”‚                   â”‚                   â”‚\n       â–¼                   â–¼                   â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  Template   â”‚    â”‚   Cron      â”‚    â”‚   Events    â”‚\nâ”‚   Engine    â”‚    â”‚ Scheduler   â”‚    â”‚ Evaluator   â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## ğŸ”§ Core Components\n\n### 1. Job Discovery System\n\n**Purpose**: Automatically discover and load job definitions from the filesystem.\n\n**Components**:\n- `src/jobs/scan.mjs` - File system scanning\n- `src/jobs/define.mjs` - Job definition validation\n- `tinyglobby` - Pattern matching for job files\n\n**Flow**:\n```\nFile System â†’ tinyglobby â†’ Dynamic Import â†’ Validation â†’ Job Registry\n```\n\n**Key Features**:\n- Recursive directory scanning\n- Pattern matching (`jobs/**/*.mjs`)\n- Dynamic ES module imports\n- Job ID inference from file paths\n- Mode detection (`.cron.mjs`, `.evt.mjs`)\n\n### 2. Job Execution Engine\n\n**Purpose**: Execute jobs with proper context, locking, and error handling.\n\n**Components**:\n- `src/jobs/runner.mjs` - Main execution engine\n- `src/composables/git.mjs` - Git operations\n- `src/composables/template.mjs` - Template rendering\n\n**Flow**:\n```\nJob Definition â†’ Lock Acquisition â†’ Context Building â†’ Execution â†’ Receipt Writing â†’ Lock Release\n```\n\n**Key Features**:\n- Atomic locking with Git refs\n- Rich execution context\n- Error handling and recovery\n- Receipt generation\n- Artifact management\n\n### 3. Template System\n\n**Purpose**: Render dynamic content using Nunjucks templates.\n\n**Components**:\n- `src/utils/nunjucks-config.mjs` - Template configuration\n- `nunjucks` - Template engine\n- Custom filters for string transformations\n\n**Flow**:\n```\nTemplate File â†’ Nunjucks Engine â†’ Custom Filters â†’ Rendered Output\n```\n\n**Key Features**:\n- Nunjucks template engine\n- Custom inflection filters\n- Template caching\n- File and string rendering\n- Dynamic variable injection\n\n### 4. Git Integration\n\n**Purpose**: Provide Git-native operations and storage.\n\n**Components**:\n- `src/composables/git.mjs` - Git operations wrapper\n- Git refs for locking\n- Git notes for receipts\n- Git log parsing\n\n**Flow**:\n```\nGit Commands â†’ execFile â†’ Error Handling â†’ Formatted Output\n```\n\n**Key Features**:\n- POSIX-first Git operations\n- Deterministic environment\n- Error handling\n- Repository information\n- Commit history parsing\n\n### 5. Cron Scheduler\n\n**Purpose**: Execute jobs on a schedule using cron expressions.\n\n**Components**:\n- `src/jobs/cron.mjs` - Cron parsing and scheduling\n- `JobDaemon` - Daemon orchestration\n- Cron expression validation\n\n**Flow**:\n```\nCron Expression â†’ Parser â†’ Schedule â†’ Timer â†’ Job Execution\n```\n\n**Key Features**:\n- Cron expression parsing\n- Schedule management\n- Next execution calculation\n- Daemon integration\n\n### 6. Event System\n\n**Purpose**: Trigger jobs based on Git events using predicates.\n\n**Components**:\n- `src/jobs/events.mjs` - Event evaluation\n- Event predicates\n- Git event detection\n\n**Flow**:\n```\nGit Events â†’ Predicate Evaluation â†’ Job Triggering â†’ Execution\n```\n\n**Key Features**:\n- Event predicate evaluation\n- Git event detection\n- Logical operators (any/all)\n- Pattern matching\n- Daemon integration\n\n### 7. Hooks System\n\n**Purpose**: Provide extensibility through lifecycle hooks.\n\n**Components**:\n- `src/jobs/hooks.mjs` - Hooks management\n- `unjs/hookable` - Hook implementation\n- Default hooks\n\n**Flow**:\n```\nJob Lifecycle â†’ Hook Registration â†’ Hook Execution â†’ Custom Logic\n```\n\n**Key Features**:\n- Lifecycle hooks\n- Custom hook registration\n- Default hooks\n- Hook statistics\n- Error handling\n\n## ğŸ”„ Data Flow\n\n### Job Execution Flow\n\n```\n1. Job Discovery\n   â”œâ”€â”€ Scan filesystem for job files\n   â”œâ”€â”€ Load job definitions\n   â””â”€â”€ Validate job schemas\n\n2. Job Execution\n   â”œâ”€â”€ Acquire lock (Git ref)\n   â”œâ”€â”€ Build execution context\n   â”œâ”€â”€ Execute job function\n   â”œâ”€â”€ Write receipt (Git notes)\n   â””â”€â”€ Release lock\n\n3. Template Rendering\n   â”œâ”€â”€ Load template file\n   â”œâ”€â”€ Apply custom filters\n   â”œâ”€â”€ Inject variables\n   â””â”€â”€ Generate output\n\n4. Git Operations\n   â”œâ”€â”€ Execute Git commands\n   â”œâ”€â”€ Parse output\n   â”œâ”€â”€ Handle errors\n   â””â”€â”€ Return formatted data\n```\n\n### Daemon Flow\n\n```\n1. Daemon Startup\n   â”œâ”€â”€ Load configuration\n   â”œâ”€â”€ Initialize schedulers\n   â”œâ”€â”€ Start cron scheduler\n   â””â”€â”€ Start event monitor\n\n2. Cron Scheduling\n   â”œâ”€â”€ Parse cron expressions\n   â”œâ”€â”€ Calculate next execution\n   â”œâ”€â”€ Schedule timer\n   â””â”€â”€ Execute jobs\n\n3. Event Monitoring\n   â”œâ”€â”€ Monitor Git events\n   â”œâ”€â”€ Evaluate predicates\n   â”œâ”€â”€ Trigger jobs\n   â””â”€â”€ Process results\n\n4. Daemon Shutdown\n   â”œâ”€â”€ Stop schedulers\n   â”œâ”€â”€ Clean up resources\n   â””â”€â”€ Graceful exit\n```\n\n## ğŸ—‚ï¸ File Organization\n\n### Directory Structure\n\n```\nplayground/\nâ”œâ”€â”€ dev.mjs                 # Main entry point\nâ”œâ”€â”€ gitvan.config.js        # Configuration\nâ”œâ”€â”€ package.json            # Dependencies\nâ”œâ”€â”€ jobs/                   # Job definitions\nâ”‚   â”œâ”€â”€ docs/\nâ”‚   â”‚   â””â”€â”€ changelog.mjs   # Changelog job\nâ”‚   â”œâ”€â”€ test/\nâ”‚   â”‚   â”œâ”€â”€ simple.mjs      # Simple job\nâ”‚   â”‚   â””â”€â”€ cleanup.cron.mjs # Cron job\nâ”‚   â””â”€â”€ alerts/\nâ”‚       â””â”€â”€ release.evt.mjs # Event job\nâ”œâ”€â”€ templates/              # Template files\nâ”‚   â””â”€â”€ changelog.njk       # Changelog template\nâ””â”€â”€ dist/                   # Generated output\n    â”œâ”€â”€ CHANGELOG.md        # Generated changelog\n    â”œâ”€â”€ status-report.json  # Generated report\n    â””â”€â”€ notifications/      # Release notifications\n```\n\n### Import Dependencies\n\n```\ndev.mjs\nâ”œâ”€â”€ src/jobs/scan.mjs\nâ”œâ”€â”€ src/jobs/runner.mjs\nâ”œâ”€â”€ src/jobs/daemon.mjs\nâ”œâ”€â”€ src/config/loader.mjs\nâ””â”€â”€ src/jobs/hooks.mjs\n\njobs/*.mjs\nâ”œâ”€â”€ gitvan/define\nâ”œâ”€â”€ gitvan/useGit\nâ””â”€â”€ gitvan/useTemplate\n\ntemplates/*.njk\nâ””â”€â”€ Nunjucks engine\n```\n\n## ğŸ” Security Considerations\n\n### Git Operations\n\n- **Read-only by default**: Most operations are read-only\n- **Atomic operations**: Lock acquisition prevents conflicts\n- **Error handling**: Graceful failure without corruption\n- **Permission checks**: Verify Git repository access\n\n### File System\n\n- **Path validation**: Prevent directory traversal\n- **Permission checks**: Verify file system access\n- **Cleanup**: Remove temporary files\n- **Error handling**: Handle file system errors\n\n### Job Execution\n\n- **Sandboxing**: Jobs run in controlled environment\n- **Resource limits**: Prevent resource exhaustion\n- **Error isolation**: Job failures don't affect system\n- **Audit trail**: Complete execution history\n\n## âš¡ Performance Considerations\n\n### Caching\n\n- **Template caching**: Cache compiled templates\n- **Job discovery**: Cache job definitions\n- **Git operations**: Cache repository information\n- **Configuration**: Cache loaded configuration\n\n### Optimization\n\n- **Parallel execution**: Run independent operations in parallel\n- **Resource pooling**: Reuse expensive resources\n- **Lazy loading**: Load resources on demand\n- **Memory management**: Clean up unused resources\n\n### Monitoring\n\n- **Execution time**: Track job performance\n- **Resource usage**: Monitor memory and CPU\n- **Error rates**: Track failure rates\n- **Throughput**: Measure job processing rate\n\n## ğŸ”§ Configuration Architecture\n\n### Configuration Loading\n\n```\ngitvan.config.js â†’ c12 â†’ defu â†’ normalizeRuntimeConfig â†’ Final Config\n```\n\n### Configuration Hierarchy\n\n1. **Defaults**: Built-in default values\n2. **User Config**: `gitvan.config.js` file\n3. **Environment**: Environment variables\n4. **Runtime**: Runtime overrides\n\n### Configuration Validation\n\n- **Schema validation**: Validate configuration structure\n- **Type checking**: Ensure correct data types\n- **Value validation**: Check value ranges and formats\n- **Dependency validation**: Verify required dependencies\n\n## ğŸ§ª Testing Architecture\n\n### Test Types\n\n1. **Unit Tests**: Individual component testing\n2. **Integration Tests**: Component interaction testing\n3. **E2E Tests**: Full system testing\n4. **Performance Tests**: Performance validation\n\n### Test Structure\n\n```\ntests/\nâ”œâ”€â”€ playground-e2e.test.mjs  # E2E tests\nâ”œâ”€â”€ composables.test.mjs    # Composable tests\nâ”œâ”€â”€ config-simple.test.mjs  # Config tests\nâ””â”€â”€ nunjucks-config.test.mjs # Template tests\n```\n\n### Test Execution\n\n- **Vitest**: Test runner and framework\n- **E2E Testing**: Full playground validation\n- **Mocking**: Isolated component testing\n- **Coverage**: Test coverage reporting\n\n## ğŸš€ Deployment Architecture\n\n### Development Mode\n\n- **Hot reload**: File watching and reloading\n- **Debug logging**: Detailed execution logs\n- **Error reporting**: Comprehensive error information\n- **Development tools**: Enhanced debugging capabilities\n\n### Production Mode\n\n- **Optimized performance**: Caching and optimization\n- **Error handling**: Graceful error recovery\n- **Logging**: Production-appropriate logging\n- **Monitoring**: Performance and health monitoring\n\n### CI/CD Integration\n\n- **Automated testing**: Run tests on changes\n- **Deployment**: Automated deployment pipeline\n- **Monitoring**: Continuous monitoring\n- **Rollback**: Quick rollback capabilities\n\n## ğŸ“Š Monitoring and Observability\n\n### Metrics\n\n- **Job execution time**: Performance metrics\n- **Success/failure rates**: Reliability metrics\n- **Resource usage**: Resource consumption\n- **Throughput**: Job processing rate\n\n### Logging\n\n- **Structured logging**: JSON-formatted logs\n- **Log levels**: Debug, info, warn, error\n- **Context information**: Rich context data\n- **Log aggregation**: Centralized logging\n\n### Health Checks\n\n- **System health**: Overall system status\n- **Component health**: Individual component status\n- **Dependency health**: External dependency status\n- **Performance health**: Performance indicators\n\nThis architecture guide provides a comprehensive understanding of the GitVan playground system design and implementation.\n"
        }
    ]
}